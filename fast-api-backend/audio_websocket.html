<!DOCTYPE html>
<html>
<head>
    <title>Audio WebSocket Test</title>
    <style>
        #messageLog {
            width: 100%;
            height: 200px;
            border: 1px solid #ccc;
            overflow-y: auto;
            margin-bottom: 20px;
            padding: 10px;
            font-family: monospace;
        }
        .message {
            margin: 5px 0;
            padding: 5px;
            border-radius: 4px;
        }
        .incoming {
            background-color: #e3f2fd;
        }
        .outgoing {
            background-color: #f5f5f5;
        }
    </style>
</head>
<body>
    <h2>Audio WebSocket Test</h2>
    <div id="messageLog"></div>
    <button onclick="startRecording()">Start Recording</button>
    <button onclick="stopRecording()">Stop Recording</button>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        const clientId = 'client_' + Math.random().toString(36).substr(2, 9);
        let ws = new WebSocket(`ws://localhost:8000/audio-ws/${clientId}`);
        const messageLog = document.getElementById('messageLog');

        function logMessage(message, direction) {
            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${direction}`;
            msgDiv.textContent = `${direction === 'incoming' ? 'Received' : 'Sent'}: ${message}`;
            messageLog.appendChild(msgDiv);
            messageLog.scrollTop = messageLog.scrollHeight;
        }

        async function startRecording() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = (event) => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                audioChunks = [];

                // Convert to base64
                const reader = new FileReader();
                reader.readAsDataURL(audioBlob);
                reader.onloadend = () => {
                    const base64Audio = reader.result;
                    ws.send(base64Audio);
                    logMessage("Audio data sent", "outgoing");
                };
            };

            mediaRecorder.start();
        }

        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        }

        ws.onmessage = async (event) => {
            try {
                const data = event.data;
                if (data.startsWith('data:audio')) {
                    logMessage("Received processed audio", "incoming");
                    const audio = new Audio(data);
                    await audio.play();
                } else {
                    const jsonResponse = JSON.parse(data);
                    if (jsonResponse.error) {
                        logMessage(`Error: ${jsonResponse.error}`, "incoming");
                    }
                }
            } catch (error) {
                console.error('Error processing message:', error);
                logMessage(`Error processing message: ${error.message}`, "incoming");
            }
        };

        ws.onclose = () => {
            logMessage("WebSocket connection closed", "incoming");
        };

        ws.onerror = (error) => {
            logMessage(`WebSocket error: ${error.message}`, "incoming");
        };
    </script>
</body>
</html> 